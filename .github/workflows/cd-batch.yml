name: Deploy Batch to Amazon ECS
on:
  push:
    branches: [ "main" ]
    paths: [ 'mopl-batch/**', 'mopl-core/**', 'mopl-infrastructure/**', 'build.gradle', '.github/workflows/cd-batch.yml' ]
env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: mopl-batch
  ECS_SERVICE: mopl-batch-service
  ECS_CLUSTER: mopl-cluster
  ECS_TASK_DEFINITION: mopl-batch/task-definition.json
  CONTAINER_NAME: mopl-batch-container
  DOCKERFILE_PATH: mopl-batch/Dockerfile
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with: { java-version: '21', distribution: 'temurin' }
    - uses: gradle/actions/setup-gradle@v3
    - run: ./gradlew :mopl-batch:bootJar -x test
    - uses: aws-actions/configure-aws-credentials@v4
      with: { aws-access-key-id: "${{ secrets.AWS_ACCESS_KEY_ID }}", aws-secret-access-key: "${{ secrets.AWS_SECRET_ACCESS_KEY }}", aws-region: "${{ env.AWS_REGION }}" }
    - id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    - id: build-image
      env: { ECR_REGISTRY: "${{ steps.login-ecr.outputs.registry }}", IMAGE_TAG: "${{ github.sha }}" }
      run: |
        docker build -t ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG -f ${{ env.DOCKERFILE_PATH }} .
        docker push ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG
        echo "image=${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
    - id: task-def
      uses: aws-actions/amazon-ecs-render-task-definition@v1
      with: { task-definition: "${{ env.ECS_TASK_DEFINITION }}", container-name: "${{ env.CONTAINER_NAME }}", image: "${{ steps.build-image.outputs.image }}" }
    - uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      with: { task-definition: "${{ steps.task-def.outputs.task-definition }}", service: "${{ env.ECS_SERVICE }}", cluster: "${{ env.ECS_CLUSTER }}", wait-for-service-stability: true }
